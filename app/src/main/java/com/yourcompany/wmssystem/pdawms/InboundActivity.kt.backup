package com.yourcompany.wmssystem.pdawms

import android.content.BroadcastReceiver
import android.content.Context
import android.content.Intent
import android.content.IntentFilter
import android.os.Bundle
import android.os.Handler
import android.os.Looper
import android.util.Log
import android.view.View
import android.view.ViewGroup
import android.widget.*
import androidx.appcompat.app.AlertDialog
import androidx.appcompat.app.AppCompatActivity
import androidx.core.content.ContextCompat
import androidx.lifecycle.lifecycleScope
import androidx.recyclerview.widget.LinearLayoutManager
import androidx.recyclerview.widget.RecyclerView
import kotlinx.coroutines.launch
import android.widget.AdapterView
import android.text.TextWatcher
import android.text.Editable
import com.bumptech.glide.Glide

// å…¥åº“å•†å“æ•°æ®ç±»
data class InboundItem(
    val sku: String,
    val product_name: String,
    val location: String,
    val quantity: Int,
    val color: String,
    val size: String,
    val image_url: String,
    val batch: String = ""
)

// æ–°çš„APIå“åº”æ¨¡å‹
data class ProductResponse(
    val success: Boolean,
    val data: ProductData?,
    val error_code: String?,
    val error_message: String?
)

data class ProductData(
    val products: List<Product>?,
    val pagination: Pagination?
)

data class Product(
    val product_id: String,
    val product_code: String,
    val product_name: String,
    val unit: String,
    val image_path: String?,
    val has_sku: Boolean,
    val category_code_1: String,
    val category_name_1: String,
    val category_code_2: String,
    val category_name_2: String,
    val description: String,
    val product_total_quantity: Int,
    val total_sku_count: Int,
    val total_location_count: Int,
    val total_color_count: Int,
    val colors: List<ColorInfo>?,
    val skus: List<SkuInfo>?,
    val created_at: String,
    val updated_at: String
)

data class ColorInfo(
    val color: String,
    val image_path: String?,
    val color_total_quantity: Int,
    val total_sku_count: Int,
    val total_location_count: Int,
    val sizes: List<SkuInfo>?
)

data class SkuInfo(
    val sku_size: String?,
    val sku_code: String,
    val sku_color: String?,
    val sku_total_quantity: Int,
    val locations: List<LocationInfo>?,
    val image_path: String?
)

data class LocationInfo(
    val location_code: String,
    val stock_quantity: Int
)

data class Pagination(
    val current_page: Int,
    val page_size: Int,
    val total_count: Int,
    val total_pages: Int,
    val has_next_page: Boolean,
    val has_prev_page: Boolean
)

// æ–°çš„å…¥åº“è¯·æ±‚æ¨¡å‹
data class InboundRequest(
    val sku_code: String,
    val location_code: String?,
    val inbound_quantity: Int,
    val batch_number: String? = null,
    val operator_id: String? = null,
    val notes: String? = null,
    val is_urgent: Boolean = false
)

// æ–°çš„å…¥åº“å“åº”æ¨¡å‹
data class InboundResponse(
    val success: Boolean,
    val inventory: InboundInventory?,
    val error_code: String?,
    val error_message: String?
)

data class InboundInventory(
    val product_code: String,
    val product_name: String,
    val location_code: String,
    val inbound_quantity: Int,
    val sku_code: String,
    val sku_color: String,
    val sku_size: String,
    val sku_location_quantity: Int,
    val sku_total_quantity: Int
)

class InboundListAdapter(
    private var items: MutableList<InboundItem>,
    private val getLocationOptions: () -> List<String>,
    private val onDeleteClick: (Int) -> Unit,
    private val onItemUpdate: (Int, InboundItem) -> Unit
) : RecyclerView.Adapter<InboundListAdapter.ViewHolder>() {
    
    // å­˜å‚¨æ¯ä¸ªå•†å“çš„çœŸå®SKUé€‰é¡¹
    private val productSkuOptions = mutableMapOf<String, ProductSkuOptions>()
    
    data class ProductSkuOptions(
        val colors: List<String>,
        val sizes: List<String>,
        val colorSizeMap: Map<String, List<String>>, // é¢œè‰²å¯¹åº”çš„å°ºç åˆ—è¡¨
        val colorSizeSkuMap: Map<String, Map<String, String>> = emptyMap() // é¢œè‰² -> å°ºç  -> SKUç¼–ç 
    )
    
    class ViewHolder(view: View) : RecyclerView.ViewHolder(view) {
        val imgProduct: ImageView
        val txtProductCode: TextView
        val spinnerColor: Spinner
        val spinnerSize: Spinner
        val spinnerLocation: Spinner
        val editQuantity: EditText
        val btnDelete: Button
        
        init {
            try {
                imgProduct = view.findViewById(R.id.imgProduct)
                txtProductCode = view.findViewById(R.id.txtProductCode)
                spinnerColor = view.findViewById(R.id.spinnerColor)
                spinnerSize = view.findViewById(R.id.spinnerSize)
                spinnerLocation = view.findViewById(R.id.spinnerLocation)
                editQuantity = view.findViewById(R.id.editQuantity)
                btnDelete = view.findViewById(R.id.btnDelete)
                Log.d("ViewHolder", "æ‰€æœ‰è§†å›¾åˆå§‹åŒ–æˆåŠŸ")
            } catch (e: Exception) {
                Log.e("ViewHolder", "è§†å›¾åˆå§‹åŒ–å¤±è´¥: ${e.message}", e)
                throw e
            }
        }
    }

    override fun onCreateViewHolder(parent: android.view.ViewGroup, viewType: Int): ViewHolder {
        try {
            Log.d("InboundAdapter", "å¼€å§‹åˆ›å»ºViewHolder")
            val layoutInflater = android.view.LayoutInflater.from(parent.context)
            Log.d("InboundAdapter", "è·å–LayoutInflateræˆåŠŸ")
            
            val view = layoutInflater.inflate(R.layout.item_inbound_product, parent, false)
            Log.d("InboundAdapter", "å¸ƒå±€inflateæˆåŠŸ")
            
            val viewHolder = ViewHolder(view)
            Log.d("InboundAdapter", "ViewHolderåˆ›å»ºæˆåŠŸ")
            
            return viewHolder
        } catch (e: Exception) {
            Log.e("InboundAdapter", "åˆ›å»ºViewHolderå¤±è´¥: ${e.message}", e)
            throw RuntimeException("ViewHolderåˆ›å»ºå¤±è´¥ï¼ŒåŸå› : ${e.message}", e)
        }
    }

    override fun onBindViewHolder(holder: ViewHolder, position: Int) {
        try {
            val item = items[position]
            Log.d("InboundAdapter", "å¼€å§‹ç»‘å®šæ•°æ®ï¼Œä½ç½®: $position")
            
            // è®¾ç½®å•†å“ä¿¡æ¯
            holder.txtProductCode.text = "${item.sku} - ${item.product_name}"
            
            // åŠ è½½å•†å“å›¾ç‰‡
            if (item.image_url.isNotEmpty()) {
                try {
                    Glide.with(holder.itemView.context)
                        .load(item.image_url)
                        .placeholder(android.R.drawable.ic_menu_gallery)
                        .error(android.R.drawable.ic_menu_gallery)
                        .into(holder.imgProduct)
                    Log.d("InboundAdapter", "åŠ è½½å›¾ç‰‡: ${item.image_url}")
                } catch (e: Exception) {
                    Log.e("InboundAdapter", "å›¾ç‰‡åŠ è½½å¤±è´¥: ${e.message}")
                    holder.imgProduct.setImageResource(android.R.drawable.ic_menu_gallery)
                }
            } else {
                holder.imgProduct.setImageResource(android.R.drawable.ic_menu_gallery)
            }
            
            // è·å–è¯¥å•†å“çš„SKUé€‰é¡¹ - ğŸ”§ ä»å®Œæ•´SKUä¸­æå–å•†å“ç¼–ç 
            val productCode = if (item.sku.contains("-")) {
                item.sku.split("-")[0]  // ä» "129092-é»„è‰²-M" æå– "129092"
            } else {
                item.sku  // å¦‚æœæ²¡æœ‰"-"ï¼Œç›´æ¥ä½¿ç”¨åŸå€¼
            }
            val skuOptions = productSkuOptions[productCode]
            Log.d("InboundAdapter", "æŸ¥æ‰¾SKUé€‰é¡¹: item.sku=${item.sku} -> productCode=$productCode -> æ‰¾åˆ°é€‰é¡¹=${skuOptions != null}")
            
            if (skuOptions != null) {
                // ä½¿ç”¨çœŸå®çš„é¢œè‰²é€‰é¡¹
                val colorAdapter = ArrayAdapter(holder.itemView.context, android.R.layout.simple_spinner_item, skuOptions.colors)
                colorAdapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item)
                holder.spinnerColor.adapter = colorAdapter
                
                // è®¾ç½®å½“å‰é€‰ä¸­çš„é¢œè‰²ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šåˆ™ä½¿ç”¨ç¬¬ä¸€ä¸ª
                val colorIndex = if (item.color.isNotEmpty()) {
                    skuOptions.colors.indexOf(item.color)
                } else {
                    0  // ä½¿ç”¨ç¬¬ä¸€ä¸ªé¢œè‰²
                }
                
                if (colorIndex >= 0 && colorIndex < skuOptions.colors.size) {
                    holder.spinnerColor.setSelection(colorIndex)
                    // æ›´æ–°itemçš„é¢œè‰²ä¸ºå½“å‰é€‰æ‹©çš„é¢œè‰²
                    val selectedColor = skuOptions.colors[colorIndex]
                    items[holder.adapterPosition] = items[holder.adapterPosition].copy(color = selectedColor)
                }
                
                // é¢œè‰²é€‰æ‹©ç›‘å¬å™¨ - æ›´æ–°å¯¹åº”çš„å°ºç é€‰é¡¹
                holder.spinnerColor.onItemSelectedListener = object : AdapterView.OnItemSelectedListener {
                    override fun onItemSelected(parent: AdapterView<*>?, view: View?, position: Int, id: Long) {
                        // ğŸš¨ è¶…çº§å®‰å…¨æ£€æŸ¥ï¼šé˜²æ­¢æ‰€æœ‰å¯èƒ½çš„å´©æºƒ
                        try {
                            // æ£€æŸ¥positionæœ‰æ•ˆæ€§
                            if (position < 0 || position >= skuOptions.colors.size) {
                                Log.w("InboundAdapter", "ğŸš¨ é¢œè‰²é€‰æ‹©ä½ç½®æ— æ•ˆ: $position, é¢œè‰²æ•°é‡: ${skuOptions.colors.size}")
                                return
                            }
                            
                            // æ£€æŸ¥holder.adapterPositionæœ‰æ•ˆæ€§
                            if (holder.adapterPosition == RecyclerView.NO_POSITION || 
                                holder.adapterPosition >= items.size || 
                                holder.adapterPosition < 0) {
                                Log.w("InboundAdapter", "ğŸš¨ é€‚é…å™¨ä½ç½®æ— æ•ˆ: ${holder.adapterPosition}, åˆ—è¡¨å¤§å°: ${items.size}")
                                return
                            }
                            
                            val selectedColor = skuOptions.colors[position]
                            val sizesForColor = skuOptions.colorSizeMap[selectedColor] ?: skuOptions.sizes
                            
                            val sizeAdapter = ArrayAdapter(holder.itemView.context, android.R.layout.simple_spinner_item, sizesForColor)
                            sizeAdapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item)
                            holder.spinnerSize.adapter = sizeAdapter
                            
                            // å†æ¬¡æ£€æŸ¥ä½ç½®æ˜¯å¦ä»ç„¶æœ‰æ•ˆï¼ˆé˜²æ­¢åœ¨æ“ä½œè¿‡ç¨‹ä¸­åˆ—è¡¨è¢«ä¿®æ”¹ï¼‰
                            if (holder.adapterPosition >= items.size || holder.adapterPosition < 0) {
                                Log.w("InboundAdapter", "ğŸš¨ æ“ä½œä¸­ä½ç½®å˜ä¸ºæ— æ•ˆ: ${holder.adapterPosition}, åˆ—è¡¨å¤§å°: ${items.size}")
                                return
                            }
                            
                            // ğŸ”§ ä¿æŒåŸæœ‰å°ºç ï¼Œä¸è¦è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ª
                            val currentItem = items[holder.adapterPosition]
                            val currentSize = currentItem.size
                            val sizeIndex = sizesForColor.indexOf(currentSize)
                            
                            if (sizeIndex >= 0) {
                                // å¦‚æœå½“å‰å°ºç åœ¨æ–°é¢œè‰²çš„å°ºç åˆ—è¡¨ä¸­ï¼Œä¿æŒé€‰æ‹©
                                holder.spinnerSize.setSelection(sizeIndex)
                                Log.d("InboundAdapter", "ä¿æŒåŸå°ºç : $currentSize (ç´¢å¼•: $sizeIndex)")
                            } else {
                                // å¦‚æœå½“å‰å°ºç ä¸åœ¨æ–°é¢œè‰²çš„åˆ—è¡¨ä¸­ï¼Œæ‰é€‰æ‹©ç¬¬ä¸€ä¸ª
                                if (sizesForColor.isNotEmpty()) {
                                    holder.spinnerSize.setSelection(0)
                                    val firstSize = sizesForColor[0]
                                    
                                    // è·å–å¯¹åº”çš„SKUç¼–ç 
                                    val skuCode = skuOptions.colorSizeSkuMap[selectedColor]?.get(firstSize) ?: currentItem.sku
                                    
                                    // ğŸ”§ æœ€ç»ˆå®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿holder.adapterPositionä»ç„¶æœ‰æ•ˆ
                                    if (holder.adapterPosition == RecyclerView.NO_POSITION || 
                                        holder.adapterPosition >= items.size || 
                                        holder.adapterPosition < 0) {
                                        Log.w("InboundAdapter", "ğŸš¨ æœ€ç»ˆæ£€æŸ¥ä½ç½®æ— æ•ˆ: ${holder.adapterPosition}, åˆ—è¡¨å¤§å°: ${items.size}")
                                        return
                                    }
                                    
                                    // æ›´æ–°itemæ•°æ®å’Œæ˜¾ç¤ºçš„å•†å“ç¼–ç 
                                    val updatedItem = items[holder.adapterPosition].copy(
                                        color = selectedColor, 
                                        size = firstSize,
                                        sku = skuCode
                                    )
                                    items[holder.adapterPosition] = updatedItem
                                    holder.txtProductCode.text = "${skuCode} - ${updatedItem.product_name}"
                                    
                                    // æ›´æ–°å•†å“å›¾ç‰‡
                                    updateProductImage(holder, updatedItem)
                                    
                                    Log.d("InboundAdapter", "é¢œè‰²å˜æ›´ï¼Œè‡ªåŠ¨é€‰æ‹©æ–°å°ºç : $selectedColor -> $firstSize, SKU: $skuCode")
                                    onItemUpdate(holder.adapterPosition, updatedItem)
                                }
                            }
                        } catch (e: Exception) {
                            Log.e("InboundAdapter", "ğŸš¨ é¢œè‰²é€‰æ‹©å™¨å‘ç”Ÿå¼‚å¸¸: ${e.message}", e)
                        }
                    }
                    
                    override fun onNothingSelected(parent: AdapterView<*>?) {}
                }
                
                // è®¾ç½®å°ºç é€‰æ‹©å™¨
                val currentColor = items[holder.adapterPosition].color
                val sizesForCurrentColor = skuOptions.colorSizeMap[currentColor] ?: skuOptions.sizes
                val sizeAdapter = ArrayAdapter(holder.itemView.context, android.R.layout.simple_spinner_item, sizesForCurrentColor)
                sizeAdapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item)
                holder.spinnerSize.adapter = sizeAdapter
                
                // è®¾ç½®å½“å‰é€‰ä¸­çš„å°ºç ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šåˆ™ä½¿ç”¨ç¬¬ä¸€ä¸ª
                val sizeIndex = if (item.size.isNotEmpty()) {
                    sizesForCurrentColor.indexOf(item.size)
                } else {
                    0  // ä½¿ç”¨ç¬¬ä¸€ä¸ªå°ºç 
                }
                
                if (sizeIndex >= 0 && sizeIndex < sizesForCurrentColor.size) {
                    holder.spinnerSize.setSelection(sizeIndex)
                    val selectedSize = sizesForCurrentColor[sizeIndex]
                    
                    // è·å–å¯¹åº”çš„SKUç¼–ç å¹¶æ›´æ–°æ˜¾ç¤º
                    val skuCode = skuOptions.colorSizeSkuMap[currentColor]?.get(selectedSize) ?: item.sku
                    val updatedItem = items[holder.adapterPosition].copy(
                        size = selectedSize,
                        sku = skuCode
                    )
                    items[holder.adapterPosition] = updatedItem
                    holder.txtProductCode.text = "${skuCode} - ${updatedItem.product_name}"
                    
                    Log.d("InboundAdapter", "åˆå§‹è®¾ç½®: é¢œè‰² $currentColor, å°ºç  $selectedSize, SKU: $skuCode")
                }
                
                // å°ºç é€‰æ‹©ç›‘å¬å™¨
                holder.spinnerSize.onItemSelectedListener = object : AdapterView.OnItemSelectedListener {
                    override fun onItemSelected(parent: AdapterView<*>?, view: View?, position: Int, id: Long) {
                        // ğŸš¨ è¶…çº§å®‰å…¨æ£€æŸ¥ï¼šé˜²æ­¢æ‰€æœ‰å¯èƒ½çš„å´©æºƒ
                        try {
                            // æ£€æŸ¥positionæœ‰æ•ˆæ€§
                            if (position < 0 || position >= sizesForCurrentColor.size) {
                                Log.w("InboundAdapter", "ğŸš¨ å°ºç é€‰æ‹©ä½ç½®æ— æ•ˆ: $position, å°ºç æ•°é‡: ${sizesForCurrentColor.size}")
                                return
                            }
                            
                            // ğŸ”§ å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿holder.adapterPositionæœ‰æ•ˆ
                            if (holder.adapterPosition == RecyclerView.NO_POSITION || 
                                holder.adapterPosition >= items.size || 
                                holder.adapterPosition < 0) {
                                Log.w("InboundAdapter", "ğŸš¨ å°ºç é€‰æ‹© - æ— æ•ˆçš„adapter position: ${holder.adapterPosition}, åˆ—è¡¨å¤§å°: ${items.size}")
                                return
                            }
                            
                            val selectedSize = sizesForCurrentColor[position]
                            val currentColor = items[holder.adapterPosition].color
                            
                            // è·å–å¯¹åº”çš„SKUç¼–ç 
                            val skuCode = skuOptions.colorSizeSkuMap[currentColor]?.get(selectedSize) 
                                ?: items[holder.adapterPosition].sku
                            
                            // å†æ¬¡æ£€æŸ¥ä½ç½®æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
                            if (holder.adapterPosition >= items.size || holder.adapterPosition < 0) {
                                Log.w("InboundAdapter", "ğŸš¨ å°ºç é€‰æ‹©æ“ä½œä¸­ä½ç½®å˜ä¸ºæ— æ•ˆ: ${holder.adapterPosition}, åˆ—è¡¨å¤§å°: ${items.size}")
                                return
                            }
                            
                            // æ›´æ–°itemæ•°æ®å’Œæ˜¾ç¤ºçš„å•†å“ç¼–ç 
                            val updatedItem = items[holder.adapterPosition].copy(
                                size = selectedSize,
                                sku = skuCode
                            )
                            items[holder.adapterPosition] = updatedItem
                            holder.txtProductCode.text = "${skuCode} - ${updatedItem.product_name}"
                            
                            // æ›´æ–°å•†å“å›¾ç‰‡
                            updateProductImage(holder, updatedItem)
                            
                            Log.d("InboundAdapter", "å°ºç é€‰æ‹©: $selectedSize, é¢œè‰²: $currentColor, SKU: $skuCode")
                            onItemUpdate(holder.adapterPosition, updatedItem)
                        } catch (e: Exception) {
                            Log.e("InboundAdapter", "ğŸš¨ å°ºç é€‰æ‹©å™¨å‘ç”Ÿå¼‚å¸¸: ${e.message}", e)
                        }
                    }
                    
                    override fun onNothingSelected(parent: AdapterView<*>?) {}
                }
                
            } else {
                // ğŸ”§ å¦‚æœæ²¡æœ‰SKUä¿¡æ¯ï¼Œä½¿ç”¨å•†å“æœ¬èº«çš„é¢œè‰²å’Œå°ºç ï¼Œä¸ä½¿ç”¨"é»˜è®¤é¢œè‰²"
                val itemColors = if (item.color.isNotEmpty()) listOf(item.color) else listOf("æœªçŸ¥é¢œè‰²")
                val itemSizes = if (item.size.isNotEmpty()) listOf(item.size) else listOf("æœªçŸ¥å°ºç ")
                
                val colorAdapter = ArrayAdapter(holder.itemView.context, android.R.layout.simple_spinner_item, itemColors)
                colorAdapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item)
                holder.spinnerColor.adapter = colorAdapter
                holder.spinnerColor.setSelection(0)
                
                val sizeAdapter = ArrayAdapter(holder.itemView.context, android.R.layout.simple_spinner_item, itemSizes)
                sizeAdapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item)
                holder.spinnerSize.adapter = sizeAdapter
                holder.spinnerSize.setSelection(0)
                
                Log.d("InboundAdapter", "ä½¿ç”¨å•†å“æœ¬èº«é¢œè‰²å°ºç : é¢œè‰²=${item.color}, å°ºç =${item.size}")
            }
            
            // è®¾ç½®è´§ä½é€‰æ‹©å™¨
            // è·å–è´§ä½é€‰é¡¹ï¼Œå¹¶æ·»åŠ ä¸€ä¸ªç©ºé€‰é¡¹ä½œä¸ºé»˜è®¤
            val currentLocationOptions = getLocationOptions().toMutableList()
            
            // ğŸ”§ ç¡®ä¿"æ— è´§ä½"åœ¨é€‰é¡¹åˆ—è¡¨ä¸­
            if (!currentLocationOptions.contains("æ— è´§ä½")) {
                currentLocationOptions.add(0, "æ— è´§ä½")  // æ·»åŠ åˆ°ç¬¬ä¸€ä½
                Log.d("InboundAdapter", "æ·»åŠ 'æ— è´§ä½'åˆ°é€‰é¡¹åˆ—è¡¨")
            }
            
            // å¦‚æœå½“å‰å•†å“çš„è´§ä½ä¸åœ¨é€‰é¡¹åˆ—è¡¨ä¸­ï¼Œæ·»åŠ å®ƒ
            if (item.location.isNotEmpty() && item.location != "æ— è´§ä½" && !currentLocationOptions.contains(item.location)) {
                currentLocationOptions.add(item.location)
                Log.d("InboundAdapter", "æ·»åŠ æ–°è´§ä½åˆ°é€‰é¡¹åˆ—è¡¨: ${item.location}")
            }
            
            val locationOptionsWithEmpty = listOf("è¯·é€‰æ‹©è´§ä½") + currentLocationOptions
            val locationAdapter = ArrayAdapter(holder.itemView.context, android.R.layout.simple_spinner_item, locationOptionsWithEmpty)
            locationAdapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item)
            holder.spinnerLocation.adapter = locationAdapter
            
            // è®¾ç½®å½“å‰é€‰ä¸­çš„è´§ä½ - ğŸ”§ ä¿®å¤"æ— è´§ä½"æ˜¾ç¤ºé—®é¢˜
            val locationIndex = if (item.location.isNotEmpty()) {
                if (item.location == "æ— è´§ä½") {
                    // å¦‚æœæ˜¯"æ— è´§ä½"ï¼Œä¹Ÿè¦åœ¨é€‰é¡¹ä¸­æŸ¥æ‰¾å¹¶é€‰æ‹©
                    val index = currentLocationOptions.indexOf("æ— è´§ä½")
                    if (index >= 0) index + 1 else 0  // +1 å› ä¸ºå‰é¢æ·»åŠ äº†"è¯·é€‰æ‹©è´§ä½"
                } else {
                    // å…¶ä»–å…·ä½“è´§ä½
                    val index = currentLocationOptions.indexOf(item.location)
                    if (index >= 0) index + 1 else 0  // +1 å› ä¸ºå‰é¢æ·»åŠ äº†"è¯·é€‰æ‹©è´§ä½"
                }
            } else {
                0  // ç©ºå­—ç¬¦ä¸²æ—¶é€‰æ‹©"è¯·é€‰æ‹©è´§ä½"
            }
            
            if (locationIndex >= 0 && locationIndex < locationOptionsWithEmpty.size) {
                holder.spinnerLocation.setSelection(locationIndex)
                Log.d("InboundAdapter", "è®¾ç½®è´§ä½é€‰æ‹©: ä½ç½®=$locationIndex, è´§ä½=${locationOptionsWithEmpty[locationIndex]}")
            }
            
            // è´§ä½é€‰æ‹©ç›‘å¬å™¨
            holder.spinnerLocation.onItemSelectedListener = object : AdapterView.OnItemSelectedListener {
                override fun onItemSelected(parent: AdapterView<*>?, view: View?, position: Int, id: Long) {
                    // ğŸš¨ è¶…çº§å®‰å…¨æ£€æŸ¥ï¼šé˜²æ­¢æ‰€æœ‰å¯èƒ½çš„å´©æºƒ
                    try {
                        // æ£€æŸ¥positionæœ‰æ•ˆæ€§
                        if (position < 0 || position >= locationOptionsWithEmpty.size) {
                            Log.w("InboundAdapter", "ğŸš¨ è´§ä½é€‰æ‹©ä½ç½®æ— æ•ˆ: $position, è´§ä½æ•°é‡: ${locationOptionsWithEmpty.size}")
                            return
                        }
                        
                        // ğŸ”§ å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿holder.adapterPositionæœ‰æ•ˆ
                        if (holder.adapterPosition == RecyclerView.NO_POSITION || 
                            holder.adapterPosition >= items.size || 
                            holder.adapterPosition < 0) {
                            Log.w("InboundAdapter", "ğŸš¨ è´§ä½é€‰æ‹© - æ— æ•ˆçš„adapter position: ${holder.adapterPosition}, åˆ—è¡¨å¤§å°: ${items.size}")
                            return
                        }
                        
                        val selectedLocation = if (position > 0) {
                            locationOptionsWithEmpty[position]
                        } else {
                            "æ— è´§ä½"  // ğŸ”§ å¦‚æœé€‰æ‹©äº†"è¯·é€‰æ‹©è´§ä½"ï¼Œè®¾ä¸º"æ— è´§ä½"è€Œä¸æ˜¯ç©ºå­—ç¬¦ä¸²
                        }
                        
                        // å†æ¬¡æ£€æŸ¥ä½ç½®æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
                        if (holder.adapterPosition >= items.size || holder.adapterPosition < 0) {
                            Log.w("InboundAdapter", "ğŸš¨ è´§ä½é€‰æ‹©æ“ä½œä¸­ä½ç½®å˜ä¸ºæ— æ•ˆ: ${holder.adapterPosition}, åˆ—è¡¨å¤§å°: ${items.size}")
                            return
                        }
                        
                        val updatedItem = items[holder.adapterPosition].copy(location = selectedLocation)
                        items[holder.adapterPosition] = updatedItem
                        onItemUpdate(holder.adapterPosition, updatedItem)
                        
                        Log.d("InboundAdapter", "è´§ä½é€‰æ‹©: $selectedLocation")
                    } catch (e: Exception) {
                        Log.e("InboundAdapter", "ğŸš¨ è´§ä½é€‰æ‹©å™¨å‘ç”Ÿå¼‚å¸¸: ${e.message}", e)
                    }
                }
                
                override fun onNothingSelected(parent: AdapterView<*>?) {}
            }
            
            // è®¾ç½®æ•°é‡
            holder.editQuantity.setText(item.quantity.toString())
            
            // æ•°é‡å˜åŒ–ç›‘å¬
            holder.editQuantity.addTextChangedListener(object : TextWatcher {
                override fun beforeTextChanged(s: CharSequence?, start: Int, count: Int, after: Int) {}
                override fun onTextChanged(s: CharSequence?, start: Int, before: Int, count: Int) {}
                override fun afterTextChanged(s: Editable?) {
                    // ğŸš¨ è¶…çº§å®‰å…¨æ£€æŸ¥ï¼šé˜²æ­¢æ‰€æœ‰å¯èƒ½çš„å´©æºƒ
                    try {
                        // ğŸ”§ å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿holder.adapterPositionæœ‰æ•ˆ
                        if (holder.adapterPosition == RecyclerView.NO_POSITION || 
                            holder.adapterPosition >= items.size || 
                            holder.adapterPosition < 0) {
                            Log.w("InboundAdapter", "ğŸš¨ æ•°é‡å˜åŒ– - æ— æ•ˆçš„adapter position: ${holder.adapterPosition}, åˆ—è¡¨å¤§å°: ${items.size}")
                            return
                        }
                        
                        val newQuantity = s.toString().toIntOrNull() ?: 1
                        items[holder.adapterPosition] = items[holder.adapterPosition].copy(quantity = newQuantity)
                        onItemUpdate(holder.adapterPosition, items[holder.adapterPosition])
                    } catch (e: Exception) {
                        Log.e("InboundAdapter", "ğŸš¨ æ•°é‡å˜åŒ–ç›‘å¬å™¨å‘ç”Ÿå¼‚å¸¸: ${e.message}", e)
                    }
                }
            })
            
            // åˆ é™¤æŒ‰é’®
            holder.btnDelete.setOnClickListener {
                onDeleteClick(position)
            }
            
            Log.d("InboundAdapter", "æ•°æ®ç»‘å®šå®Œæˆ")
        } catch (e: Exception) {
            Log.e("InboundAdapter", "ç»‘å®šæ•°æ®å¤±è´¥: ${e.message}", e)
        }
    }

    override fun getItemCount() = items.size

    fun updateItems(newItems: MutableList<InboundItem>) {
        items = newItems
        notifyDataSetChanged()
    }
    
    // æ›´æ–°å•†å“å›¾ç‰‡
    private fun updateProductImage(holder: ViewHolder, item: InboundItem) {
        if (item.image_url.isNotEmpty()) {
            try {
                Glide.with(holder.itemView.context)
                    .load(item.image_url)
                    .placeholder(android.R.drawable.ic_menu_gallery)
                    .error(android.R.drawable.ic_menu_gallery)
                    .into(holder.imgProduct)
                Log.d("InboundAdapter", "æ›´æ–°å›¾ç‰‡: ${item.image_url}")
            } catch (e: Exception) {
                Log.e("InboundAdapter", "å›¾ç‰‡æ›´æ–°å¤±è´¥: ${e.message}")
                holder.imgProduct.setImageResource(android.R.drawable.ic_menu_gallery)
            }
        } else {
            holder.imgProduct.setImageResource(android.R.drawable.ic_menu_gallery)
        }
    }
    
    // è®¾ç½®å•†å“çš„SKUé€‰é¡¹ - æ›´æ–°ä¸ºæ–°çš„APIç»“æ„
    fun setProductSkuOptions(productCode: String, colors: List<ColorInfo>?, skus: List<SkuInfo>?) {
        Log.d("InboundAdapter", "è®¾ç½®å•†å“ $productCode çš„SKUé€‰é¡¹: colors=${colors?.size}, skus=${skus?.size}")
        
        if (colors.isNullOrEmpty()) {
            Log.w("InboundAdapter", "é¢œè‰²æ•°æ®ä¸ºç©ºï¼Œæ— æ³•è®¾ç½®SKUé€‰é¡¹")
            return
        }
        
        // æå–æ‰€æœ‰é¢œè‰²
        val allColors = colors.map { it.color }.distinct()
        
        // åˆ›å»ºé¢œè‰²åˆ°å°ºç -SKUçš„æ˜ å°„
        val colorSizeMap = mutableMapOf<String, List<String>>()
        val colorSizeSkuMap = mutableMapOf<String, MutableMap<String, String>>() // é¢œè‰² -> å°ºç  -> SKUç¼–ç 
        
        // ä»colorsæ•°æ®ä¸­æå–æ¯ä¸ªé¢œè‰²çš„å°ºç å’ŒSKUä¿¡æ¯
        for (colorInfo in colors) {
            val colorName = colorInfo.color
            val sizesForColor = mutableListOf<String>()
            val sizeSkuMapForColor = mutableMapOf<String, String>()
            
            colorInfo.sizes?.forEach { skuInfo ->
                val size = skuInfo.sku_size
                val skuCode = skuInfo.sku_code
                if (size != null && skuCode.isNotEmpty()) {
                    sizesForColor.add(size)
                    sizeSkuMapForColor[size] = skuCode
                    Log.d("InboundAdapter", "é¢œè‰² $colorName, å°ºç  $size -> SKU: $skuCode")
                }
            }
            
            if (sizesForColor.isNotEmpty()) {
                colorSizeMap[colorName] = sizesForColor.distinct()
                colorSizeSkuMap[colorName] = sizeSkuMapForColor
            } else {
                // å¦‚æœè¯¥é¢œè‰²æ²¡æœ‰å°ºç æ•°æ®ï¼Œä½¿ç”¨é€šç”¨å°ºç 
                colorSizeMap[colorName] = listOf("å‡ç ")
                colorSizeSkuMap[colorName] = mutableMapOf("å‡ç " to productCode)
            }
        }
        
        // æå–æ‰€æœ‰å°ºç 
        val allSizes = colorSizeMap.values.flatten().distinct()
        val finalSizes = if (allSizes.isEmpty()) listOf("å‡ç ") else allSizes
        
        productSkuOptions[productCode] = ProductSkuOptions(
            colors = allColors,
            sizes = finalSizes,
            colorSizeMap = colorSizeMap,
            colorSizeSkuMap = colorSizeSkuMap
        )
        
        Log.d("InboundAdapter", "æˆåŠŸè®¾ç½®å•†å“ $productCode çš„SKUé€‰é¡¹:")
        Log.d("InboundAdapter", "  é¢œè‰²${allColors.size}ä¸ª: $allColors")
        Log.d("InboundAdapter", "  å°ºç ${finalSizes.size}ä¸ª: $finalSizes")
        Log.d("InboundAdapter", "  é¢œè‰²-å°ºç æ˜ å°„: $colorSizeMap")
        Log.d("InboundAdapter", "  é¢œè‰²-å°ºç -SKUæ˜ å°„: $colorSizeSkuMap")
    }
}

class InboundActivity : AppCompatActivity() {
    private lateinit var editProductCode: EditText
    private lateinit var btnConfirmProduct: Button
    private lateinit var txtInboundTitle: TextView
    private lateinit var recyclerInboundList: RecyclerView
    private lateinit var btnConfirmInbound: Button
    private lateinit var editLocationInput: androidx.appcompat.widget.AppCompatAutoCompleteTextView
    
    private lateinit var inboundListAdapter: InboundListAdapter
    private val inboundItems = mutableListOf<InboundItem>()

    // ç»Ÿä¸€å¯¼èˆªæ 
    private lateinit var unifiedNavBar: UnifiedNavBar

    // APIç›¸å…³å˜é‡
    private var locationOptions = mutableListOf<String>()
    
    // ğŸš€ æ‰«æé˜Ÿåˆ—å¤„ç†æœºåˆ¶ - ç»å¯¹ä¸ä¸¢å¤±ä»»ä½•æ‰«æ
    private val scanQueue = mutableListOf<String>()
    private var isProcessingQueue = false
    private var lastScanTime = 0L
    private var lastScanCode = ""

    // æ‰«ç å¹¿æ’­æ¥æ”¶å™¨
    private val scanReceiver = object : BroadcastReceiver() {
        override fun onReceive(context: Context?, intent: Intent?) {
            val scanData = when (intent?.action) {
                "android.intent.action.SCANRESULT" -> intent.getStringExtra("value")
                "android.intent.ACTION_DECODE_DATA" -> intent.getStringExtra("barcode_string")
                "com.symbol.datawedge.api.RESULT_ACTION" -> intent.getStringExtra("com.symbol.datawedge.data_string")
                "com.honeywell.decode.intent.action.SCAN_RESULT" -> intent.getStringExtra("SCAN_RESULT")
                "nlscan.action.SCANNER_RESULT" -> intent.getStringExtra("SCAN_BARCODE1")
                "scan.rcv.message" -> intent.getStringExtra("barocode")
                else -> null
            }
            
            scanData?.let { insertToFocusedEditText(it) }
        }
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        Log.e("InboundActivity", "ğŸ”¥ğŸ”¥ğŸ”¥ onCreate() å¼€å§‹æ‰§è¡Œï¼ğŸ”¥ğŸ”¥ğŸ”¥")
        setContentView(R.layout.activity_inbound)

        // åˆå§‹åŒ– API å®¢æˆ·ç«¯
        ApiClient.init(this)
        
        // éªŒè¯æœåŠ¡å™¨åœ°å€æ˜¯å¦å·²è®¾ç½®
        val currentServerUrl = ApiClient.getServerUrl(this)
        if (currentServerUrl.isEmpty()) {
            Log.e("InboundActivity", "âŒ æœåŠ¡å™¨åœ°å€æœªè®¾ç½®ï¼Œè¯·è¿”å›ç™»å½•é¡µé¢è®¾ç½®æœåŠ¡å™¨åœ°å€")
            Toast.makeText(this, "æœåŠ¡å™¨åœ°å€æœªè®¾ç½®ï¼Œè¯·é‡æ–°ç™»å½•", Toast.LENGTH_LONG).show()
            finish()
            return
        } else {
            Log.d("InboundActivity", "âœ… ä½¿ç”¨æœåŠ¡å™¨åœ°å€: $currentServerUrl")
        }

        initViews()
        initUnifiedNavBar()
        setupRecyclerView()
        setupScanReceiver()
        setupClickListeners()
        loadLocationOptions()
        
        // ğŸ§¹ å¯åŠ¨æ—¶æ¸…ç†é‡å¤è®°å½•
        Log.d("InboundActivity", "ğŸš€ å¼€å§‹å¯åŠ¨æ—¶æ¸…ç†...")
        mergeduplicateItems()
        
        // ğŸš¨ ä¸´æ—¶å¼ºåˆ¶æ¸…ç†æ‰€æœ‰é‡å¤è®°å½•
        Handler(Looper.getMainLooper()).postDelayed({
            Log.d("InboundActivity", "ğŸ§¹ å»¶è¿Ÿ1ç§’åå¼ºåˆ¶æ¸…ç†é‡å¤è®°å½•...")
            mergeduplicateItems()
        }, 1000)
        
        // ğŸš¨ å†æ¬¡å¼ºåˆ¶æ¸…ç†
        Handler(Looper.getMainLooper()).postDelayed({
            Log.d("InboundActivity", "ğŸ§¹ å»¶è¿Ÿ3ç§’åå†æ¬¡å¼ºåˆ¶æ¸…ç†...")
            mergeduplicateItems()
        }, 3000)
        
        Log.e("InboundActivity", "ğŸ”¥ğŸ”¥ğŸ”¥ onCreate() æ‰§è¡Œå®Œæˆï¼ğŸ”¥ğŸ”¥ğŸ”¥")
    }

    private fun initViews() {
        editProductCode = findViewById(R.id.editProductCode)
        btnConfirmProduct = findViewById(R.id.btnConfirmProduct)
        txtInboundTitle = findViewById(R.id.txtInboundTitle)
        recyclerInboundList = findViewById(R.id.recyclerInboundList)
        btnConfirmInbound = findViewById(R.id.btnConfirmInbound)
        editLocationInput = findViewById(R.id.editLocationInput)
        
        // è®¾ç½®è´§ä½é€‰æ‹©å™¨çš„é…ç½®
        editLocationInput.threshold = 0  // è®¾ç½®ä¸º0ï¼Œè¿™æ ·ç‚¹å‡»å°±ä¼šæ˜¾ç¤ºæ‰€æœ‰é€‰é¡¹
        editLocationInput.hint = "æ— è´§ä½"
        editLocationInput.setText("")  // æ¸…ç©ºåˆå§‹æ–‡æœ¬
        
        // è®¾ç½®ç‚¹å‡»ç›‘å¬ï¼Œç‚¹å‡»æ—¶æ˜¾ç¤ºä¸‹æ‹‰åˆ—è¡¨
        editLocationInput.setOnClickListener {
            editLocationInput.showDropDown()
        }
        
        // è®¾ç½®ç„¦ç‚¹ç›‘å¬ï¼Œè·å¾—ç„¦ç‚¹æ—¶æ˜¾ç¤ºä¸‹æ‹‰åˆ—è¡¨
        editLocationInput.setOnFocusChangeListener { _, hasFocus ->
            if (hasFocus) {
                editLocationInput.showDropDown()
            }
        }
    }
    
    private fun initUnifiedNavBar() {
        val navBarContainer = findViewById<LinearLayout>(R.id.navBarContainer)
        unifiedNavBar = UnifiedNavBar.addToActivity(this, navBarContainer, "inbound")
    }

    private fun setupRecyclerView() {
        inboundListAdapter = InboundListAdapter(
            inboundItems,
            { locationOptions },  // ä¼ é€’ä¸€ä¸ªè·å–è´§ä½é€‰é¡¹çš„å‡½æ•°
            onDeleteClick = { position -> removeItemAt(position) },
            onItemUpdate = { position, updatedItem -> 
                inboundItems[position] = updatedItem
                updateItemCount()
                
                // ğŸ”„ æ£€æŸ¥ä¿®æ”¹åæ˜¯å¦ä¸å…¶ä»–å•†å“é‡å¤ï¼Œå¦‚æœé‡å¤åˆ™åˆå¹¶
                Log.d("InboundActivity", "ğŸ”„ å•†å“ä¿¡æ¯å·²æ›´æ–°ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦åˆå¹¶é‡å¤é¡¹...")
                mergeduplicateItems()
            }
        )
        recyclerInboundList.layoutManager = LinearLayoutManager(this)
        recyclerInboundList.adapter = inboundListAdapter
    }

    private fun setupScanReceiver() {
        val intentFilter = IntentFilter().apply {
            addAction("android.intent.action.SCANRESULT")
            addAction("android.intent.ACTION_DECODE_DATA")
            addAction("com.symbol.datawedge.api.RESULT_ACTION")
            addAction("com.honeywell.decode.intent.action.SCAN_RESULT")
            addAction("nlscan.action.SCANNER_RESULT")
            addAction("scan.rcv.message")
        }
        registerReceiver(scanReceiver, intentFilter)
    }

    private fun setupClickListeners() {
        // å•†å“ç¡®è®¤æŒ‰é’®
        btnConfirmProduct.setOnClickListener {
            Log.e("InboundActivity", "â˜…â˜…â˜… ç¡®è®¤æŒ‰é’®è¢«ç‚¹å‡»äº†ï¼â˜…â˜…â˜…")
            addProductToList()
        }

        // ç¡®è®¤å…¥åº“æŒ‰é’®
        btnConfirmInbound.setOnClickListener {
            confirmInbound()
        }

        // å•†å“ç è¾“å…¥ç›‘å¬
        editProductCode.setOnFocusChangeListener { _, hasFocus ->
            if (!hasFocus && editProductCode.text.toString().isNotEmpty()) {
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è‡ªåŠ¨æœç´¢é€»è¾‘
            }
        }
    }

    private fun insertToFocusedEditText(data: String) {
        runOnUiThread {
            val focusedView = currentFocus
            when (focusedView) {
                editProductCode -> {
                    editProductCode.setText(data)
                    // æ‰«ç åè‡ªåŠ¨æ·»åŠ åˆ°åˆ—è¡¨
                    addProductToList()
                }
                else -> {
                    // å¦‚æœç„¦ç‚¹åœ¨å…¶ä»–åœ°æ–¹ï¼Œé»˜è®¤å¡«å…¥å•†å“ç è¾“å…¥æ¡†
                    editProductCode.setText(data)
                    addProductToList()
                }
            }
        }
    }

    private fun loadLocationOptions() {
        Log.d("InboundActivity", "å¼€å§‹åŠ è½½åº“ä½é€‰é¡¹...")
        
        // ä¼˜å…ˆä»APIè·å–çœŸå®åº“ä½æ•°æ®
        lifecycleScope.launch {
            try {
                Log.d("InboundActivity", "æ­£åœ¨è°ƒç”¨APIè·å–åº“ä½æ•°æ®...")
                val response = ApiClient.getApiService().getInventoryByLocation()
                
                if (response.isSuccessful) {
                    val apiResponse = response.body()
                    Log.d("InboundActivity", "APIå“åº”: success=${apiResponse?.success}, data_size=${apiResponse?.data?.size}")
                    
                    if (apiResponse?.success == true && apiResponse.data != null) {
                        locationOptions.clear()
                        locationOptions.add("æ— è´§ä½")
                        
                        // æå–æ‰€æœ‰å”¯ä¸€çš„åº“ä½ä»£ç 
                        val uniqueLocations = apiResponse.data
                            .mapNotNull { it.location_code }
                            .filter { it.isNotBlank() && it != "null" }
                            .distinct()
                            .sorted()
                        
                        locationOptions.addAll(uniqueLocations)
                        
                        Log.d("InboundActivity", "æˆåŠŸåŠ è½½åº“ä½: ${uniqueLocations.size} ä¸ª")
                        Log.d("InboundActivity", "åº“ä½åˆ—è¡¨: $locationOptions")
                        
                        runOnUiThread {
                            val adapter = ArrayAdapter(this@InboundActivity, 
                                android.R.layout.simple_dropdown_item_1line, locationOptions)
                            editLocationInput.setAdapter(adapter)
                            Toast.makeText(this@InboundActivity, "å·²åŠ è½½ ${uniqueLocations.size} ä¸ªåº“ä½", Toast.LENGTH_SHORT).show()
                        }
                    } else {
                        Log.w("InboundActivity", "APIè¿”å›æ•°æ®ä¸ºç©ºæˆ–å¤±è´¥: ${apiResponse?.error_message}")
                        loadDefaultLocations()
                    }
                } else {
                    Log.w("InboundActivity", "APIè°ƒç”¨å¤±è´¥: ${response.code()}")
                    loadDefaultLocations()
                }
            } catch (e: Exception) {
                Log.e("InboundActivity", "åŠ è½½åº“ä½å¤±è´¥: ${e.message}")
                loadDefaultLocations()
            }
        }
    }
    
    private fun loadDefaultLocations() {
        Log.d("InboundActivity", "åŠ è½½é»˜è®¤åº“ä½åˆ—è¡¨...")
        
        locationOptions.clear()
        locationOptions.addAll(listOf(
            "æ— è´§ä½", "A01-01-01", "A01-01-02", "A01-02-01", "A01-02-02",
            "B01-01-01", "B01-01-02", "B02-01-01", "B02-01-02",
            "C01-01-01", "C01-01-02", "C02-01-01", "C02-01-02"
        ))
        
        Log.d("InboundActivity", "é»˜è®¤åº“ä½åˆ—è¡¨: $locationOptions")
        
        runOnUiThread {
            // ç¡®ä¿æ¸…ç©ºä¹‹å‰çš„å†…å®¹
            editLocationInput.setText("")
            editLocationInput.hint = "é€‰æ‹©åº“ä½"
            
            val adapter = ArrayAdapter(this@InboundActivity, 
                android.R.layout.simple_dropdown_item_1line, locationOptions)
            editLocationInput.setAdapter(adapter)
            
            Log.d("InboundActivity", "åº“ä½é€‚é…å™¨å·²è®¾ç½®ï¼ŒåŒ…å« ${locationOptions.size} ä¸ªé€‰é¡¹")
        }
    }

    private fun addProductToList() {
        // ğŸ¯ ç‰ˆæœ¬æ ‡è¯†ï¼šv6.7 ç»å¯¹ä¸ä¸¢å¤±ç‰ˆ
        Log.e("InboundActivity", "ğŸ¯ğŸ¯ğŸ¯ v6.7 ç»å¯¹ä¸ä¸¢å¤±ç‰ˆ æ­£åœ¨è¿è¡Œï¼ğŸ¯ğŸ¯ğŸ¯")
        Log.e("InboundActivity", "â˜…â˜…â˜… addProductToList() æ–¹æ³•è¢«è°ƒç”¨äº†ï¼â˜…â˜…â˜…")
        
        // ğŸš¨ å¼ºåˆ¶æ¸…ç†å†å²é‡å¤è®°å½• - æ¯æ¬¡æ‰«æå‰éƒ½æ‰§è¡Œ
        Log.e("InboundActivity", "ğŸš¨ğŸš¨ğŸš¨ å¼ºåˆ¶æ¸…ç†å†å²é‡å¤è®°å½•ï¼ğŸš¨ğŸš¨ğŸš¨")
        val beforeSize = inboundItems.size
        mergeduplicateItems()
        val afterSize = inboundItems.size
        if (beforeSize != afterSize) {
            Log.e("InboundActivity", "ğŸ§¹ æ¸…ç†å®Œæˆ: $beforeSize â†’ $afterSize")
        }
        
        // ğŸ”¥ æ–°å¢ï¼šæ£€æµ‹å’Œåˆ é™¤ä¸æ‰«æç ä¸åŒ¹é…çš„é”™è¯¯è®°å½•
        Log.e("InboundActivity", "ğŸ”¥ğŸ”¥ğŸ”¥ æ£€æµ‹é”™è¯¯æ•°æ®ï¼ğŸ”¥ğŸ”¥ğŸ”¥")
        val scannedParts = editProductCode.text.toString().split("-")
        if (scannedParts.size >= 3) {
            val scannedProduct = scannedParts[0]
            val scannedColor = scannedParts[1] 
            val scannedSize = scannedParts[2]
            
            Log.e("InboundActivity", "æ‰«æè§£æ: å•†å“=$scannedProduct, é¢œè‰²=$scannedColor, å°ºç =$scannedSize")
            
            // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç›¸åŒå•†å“å’Œé¢œè‰²ä½†ä¸åŒå°ºç çš„é”™è¯¯è®°å½•
            val toRemove = mutableListOf<Int>()
            inboundItems.forEachIndexed { index, item ->
                val itemParts = item.sku.split("-")
                if (itemParts.size >= 3) {
                    val itemProduct = itemParts[0]
                    val itemColor = itemParts[1]
                    val itemSize = itemParts[2]
                    
                    // å¦‚æœæ˜¯ç›¸åŒå•†å“+é¢œè‰²ä½†ä¸åŒå°ºç ï¼Œæ ‡è®°åˆ é™¤
                    if (itemProduct == scannedProduct && itemColor == scannedColor && itemSize != scannedSize) {
                        Log.e("InboundActivity", "ğŸ—‘ï¸ å‘ç°é”™è¯¯è®°å½•[$index]: ${item.sku} (åº”è¯¥æ˜¯${scannedSize}ç ï¼Œä½†æ˜¾ç¤º${itemSize}ç )")
                        toRemove.add(index)
                    }
                }
            }
            
            // ä»åå¾€å‰åˆ é™¤ï¼Œé¿å…ç´¢å¼•é”™ä¹±
            toRemove.sortedDescending().forEach { index ->
                val removedItem = inboundItems.removeAt(index)
                Log.e("InboundActivity", "ğŸ—‘ï¸ å·²åˆ é™¤é”™è¯¯è®°å½•: ${removedItem.sku}")
            }
            
            if (toRemove.isNotEmpty()) {
                inboundListAdapter.notifyDataSetChanged()
                Log.e("InboundActivity", "ğŸ—‘ï¸ åˆ é™¤äº†${toRemove.size}æ¡é”™è¯¯è®°å½•")
                Toast.makeText(this, "å·²æ¸…ç†${toRemove.size}æ¡é”™è¯¯çš„å°ºç è®°å½•", Toast.LENGTH_LONG).show()
            }
        }
        
        val productCode = editProductCode.text.toString().trim()
        Log.e("InboundActivity", "è¾“å…¥çš„å•†å“ç¼–ç : [$productCode]")
        
        if (productCode.isEmpty()) {
            Toast.makeText(this, "è¯·è¾“å…¥å•†å“ç¼–ç ", Toast.LENGTH_SHORT).show()
            return
        }

        // ğŸ”’ é˜²æ­¢é‡å¤å¤„ç†
        val currentTime = System.currentTimeMillis()
        
        // ğŸ” æ‰«æå‰çŠ¶æ€æ£€æŸ¥
        Log.d("InboundActivity", "ğŸ“Š æ‰«æå‰åˆ—è¡¨çŠ¶æ€:")
        Log.d("InboundActivity", "ğŸ“Š åˆ—è¡¨å¤§å°: ${inboundItems.size}")
        inboundItems.forEachIndexed { index, item ->
            Log.d("InboundActivity", "ğŸ“Š [$index]: sku=${item.sku}, quantity=${item.quantity}")
        }
        
        // ğŸš€ å…è®¸å¤§é‡å¹¶å‘ï¼Œä½†é™åˆ¶è¿‡åº¦å¹¶å‘ï¼ˆæœ€å¤šåŒæ—¶å¤„ç†10ä¸ªæ‰«æï¼‰
        if (scanQueue.size >= 10) {
            Log.w("InboundActivity", "âš ï¸ å¹¶å‘å¤„ç†è¶…é™ï¼Œå½“å‰å¤„ç†ä¸­: ${scanQueue.size}ï¼Œå¿½ç•¥: $productCode")
            return
        }
        
        // ğŸš€ æé€Ÿé˜²é‡å¤ï¼šåªæœ‰å½“ç¡®å®æ˜¯ç›¸åŒæ¡ç ä¸”åœ¨100mså†…æ‰é˜»æ­¢ï¼ˆåŸºæœ¬ä¸é™åˆ¶ï¼‰
        if (productCode == lastScanCode && currentTime - lastScanTime < 100) {
            Log.w("InboundActivity", "âš ï¸ æçŸ­æ—¶é—´é‡å¤æ‰«æè¢«å¿½ç•¥: $productCode (è·ä¸Šæ¬¡æ‰«æ ${currentTime - lastScanTime}ms)")
            return
        }
        
        scanQueue.add(productCode)
        Log.d("InboundActivity", "ğŸ“ˆ æ‰«æè®¡æ•°å™¨: ${scanQueue.size} (å½“å‰å¹¶å‘å¤„ç†æ•°)")
        // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œæ›´æ–°lastScanTimeå’ŒlastScanCodeï¼Œè€Œæ˜¯åœ¨å¤„ç†å®Œæˆåæ ¹æ®ç»“æœå†³å®š
        
        // è·å–è´§ä½è¾“å…¥ï¼Œç©ºç™½æ—¶ç»Ÿä¸€è®¾ä¸º"æ— è´§ä½"
        val locationInput = editLocationInput.text.toString().trim()
        val selectedLocation = if (locationInput.isNotEmpty() && locationInput != productCode) locationInput else "æ— è´§ä½"
        
        Log.d("InboundActivity", "è´§ä½è¾“å…¥: [$locationInput] -> é€‰æ‹©è´§ä½: [$selectedLocation]")
        Log.d("InboundActivity", "âš ï¸ æ³¨æ„ï¼šå¦‚æœè´§ä½è¾“å…¥å’Œå•†å“ç¼–ç ç›¸åŒï¼Œåˆ™è§†ä¸ºæ— è´§ä½")
        
        // æ¸…ç©ºè´§ä½è¾“å…¥æ¡†ï¼Œé¿å…è¢«æ‰«ç æ•°æ®æ±¡æŸ“
        if (locationInput == productCode) {
            editLocationInput.setText("")
        }
        
        // å¦‚æœæ˜¯æ–°è¾“å…¥çš„è´§ä½ï¼Œæ·»åŠ åˆ°é€‰é¡¹åˆ—è¡¨ä¸­
        if (selectedLocation.isNotEmpty() && selectedLocation != "æ— è´§ä½" && !locationOptions.contains(selectedLocation)) {
            locationOptions.add(selectedLocation)
            locationOptions.sort() // ä¿æŒæ’åº
            Log.d("InboundActivity", "æ·»åŠ æ–°è´§ä½åˆ°é€‰é¡¹åˆ—è¡¨: $selectedLocation")
            
            // æ›´æ–°AutoCompleteTextViewçš„é€‚é…å™¨
            runOnUiThread {
                val adapter = ArrayAdapter(this@InboundActivity, android.R.layout.simple_dropdown_item_1line, locationOptions)
                editLocationInput.setAdapter(adapter)
            }
        }

        // å…ˆè¿›è¡ŒAPIæŸ¥è¯¢è·å–çœŸå®çš„SKUä¿¡æ¯ï¼Œç„¶åå†æ£€æŸ¥é‡å¤

        // ä½¿ç”¨APIæŸ¥è¯¢å•†å“ä¿¡æ¯
        lifecycleScope.launch {
            try {
                Log.d("InboundActivity", "======== å¼€å§‹APIæŸ¥è¯¢è¿‡ç¨‹ ========")
                Log.d("InboundActivity", "æŸ¥è¯¢å•†å“ç¼–ç : $productCode")
                Log.d("InboundActivity", "æœåŠ¡å™¨åœ°å€: ${ApiClient.getServerUrl(this@InboundActivity)}")
                Log.d("InboundActivity", "ç™»å½•çŠ¶æ€: ${ApiClient.isLoggedIn()}")
                Log.d("InboundActivity", "ç”¨æˆ·ID: ${ApiClient.getCurrentUserId()}")
                
                var productData: Product? = null
                var skuCode: String? = null
                var productName = "æœªçŸ¥å•†å“"
                var defaultColor = "é»˜è®¤é¢œè‰²"
                var defaultSize = "é»˜è®¤å°ºç "
                var imageUrl = ""
                
                // ğŸ”§ æœ¬åœ°æ¡ç è§£æï¼šä¼˜å…ˆä»æ¡ç ä¸­æå–é¢œè‰²å’Œå°ºç ä¿¡æ¯
                val localParsedInfo = parseProductCodeLocally(productCode)
                var useLocalParsing = false
                var lockedColor = "é»˜è®¤é¢œè‰²"
                var lockedSize = "é»˜è®¤å°ºç "
                
                if (localParsedInfo != null) {
                    // ğŸ”’ é”å®šæœ¬åœ°è§£æç»“æœï¼Œç»å¯¹ä¸å…è®¸è¢«APIè¦†ç›–
                    lockedColor = localParsedInfo.color
                    lockedSize = localParsedInfo.size
                    defaultColor = lockedColor
                    defaultSize = lockedSize
                    productName = localParsedInfo.productCode
                    useLocalParsing = true
                    Log.d("InboundActivity", "ğŸ”’ æœ¬åœ°è§£æé”å®š: å•†å“=${localParsedInfo.productCode}, é¢œè‰²=$lockedColor, å°ºç =$lockedSize")
                } else {
                    Log.d("InboundActivity", "âŒ æœ¬åœ°è§£æå¤±è´¥ï¼Œä½¿ç”¨APIè§£æ")
                }

                // 1. å…ˆå°è¯•ä½œä¸ºå•†å“ç¼–ç æŸ¥è¯¢
                try {
                    Log.d("InboundActivity", "å¼€å§‹æŸ¥è¯¢å•†å“ç¼–ç : $productCode")
                    val response = ApiClient.getApiService().getProductByCode(productCode)
                    Log.d("InboundActivity", "APIå“åº”çŠ¶æ€: ${response.code()}")
                    
                    if (response.isSuccessful) {
                        val apiResponse = response.body()
                        Log.d("InboundActivity", "APIå“åº”å†…å®¹: success=${apiResponse?.success}, dataå­˜åœ¨=${apiResponse?.data != null}")
                        
                        if (apiResponse?.success == true && apiResponse.data != null) {
                            productData = apiResponse.data
                            productName = productData.product_name
                            skuCode = productData.matched_sku?.sku_code ?: productCode
                            
                            // ğŸ”’ å¦‚æœæœ¬åœ°è§£ææˆåŠŸï¼Œåˆ™ç»å¯¹ä½¿ç”¨æœ¬åœ°è§£æç»“æœï¼Œå®Œå…¨å¿½ç•¥APIæ•°æ®
                            if (useLocalParsing) {
                                // å¼ºåˆ¶ä½¿ç”¨é”å®šçš„æœ¬åœ°è§£æç»“æœ
                                defaultColor = lockedColor
                                defaultSize = lockedSize
                                Log.d("InboundActivity", "ğŸ”’ å¼ºåˆ¶ä½¿ç”¨æœ¬åœ°è§£æ: é¢œè‰²=$lockedColor, å°ºç =$lockedSize (å®Œå…¨å¿½ç•¥API)")
                            } else {
                                // åªæœ‰æœ¬åœ°è§£æå¤±è´¥æ—¶ï¼Œæ‰ä½¿ç”¨APIçš„é¢œè‰²å°ºç ä¿¡æ¯
                                if (productData.matched_sku?.sku_color?.isNotEmpty() == true) {
                                    defaultColor = productData.matched_sku.sku_color
                                    Log.d("InboundActivity", "âœ… ä½¿ç”¨APIé¢œè‰²: $defaultColor (æœ¬åœ°è§£æå¤±è´¥)")
                                }
                                if (productData.matched_sku?.sku_size?.isNotEmpty() == true) {
                                    defaultSize = productData.matched_sku.sku_size
                                    Log.d("InboundActivity", "âœ… ä½¿ç”¨APIå°ºç : $defaultSize (æœ¬åœ°è§£æå¤±è´¥)")
                                }
                            }
                            Log.d("InboundActivity", "âœ… æœ€ç»ˆä½¿ç”¨ç»“æœ: é¢œè‰²=$defaultColor, å°ºç =$defaultSize")
                            
                            // è·å–å›¾ç‰‡URL - ä¼˜å…ˆä½¿ç”¨åŒ¹é…çš„SKUå›¾ç‰‡ï¼Œç„¶åæ˜¯å•†å“å›¾ç‰‡
                            val rawImageUrl = productData.matched_sku?.image_path 
                                ?: productData.image_path 
                                ?: ""
                            
                            // å¤„ç†å›¾ç‰‡URLï¼Œå¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„åˆ™æ‹¼æ¥æœåŠ¡å™¨åœ°å€
                            imageUrl = if (rawImageUrl.isNotEmpty()) {
                                if (rawImageUrl.startsWith("http://") || rawImageUrl.startsWith("https://")) {
                                    rawImageUrl
                                } else {
                                    val baseUrl = ApiClient.getServerUrl(this@InboundActivity)
                                    "${baseUrl.trimEnd('/')}/$rawImageUrl"
                                }
                            } else {
                                ""
                            }
                            
                            Log.d("InboundActivity", "å•†å“æŸ¥è¯¢æˆåŠŸ: name=$productName, colors=${productData.colors?.size}, skus=${productData.skus?.size}")
                            if (productData.colors != null) {
                                Log.d("InboundActivity", "é¢œè‰²åˆ—è¡¨: ${productData.colors.map { it.color }}")
                            }
                            if (productData.skus != null) {
                                Log.d("InboundActivity", "SKUåˆ—è¡¨: ${productData.skus.map { "${it.sku_color}/${it.sku_size}" }}")
                            }
                        } else {
                            Log.w("InboundActivity", "APIè¿”å›å¤±è´¥æˆ–æ— æ•°æ®: ${apiResponse?.error_message}")
                        }
                    } else {
                        Log.w("InboundActivity", "APIè°ƒç”¨å¤±è´¥: ${response.code()} - ${response.message()}")
                    }
                } catch (e: Exception) {
                    Log.e("InboundActivity", "å•†å“ç¼–ç æŸ¥è¯¢å¼‚å¸¸: ${e.message}", e)
                }

                // 2. å¦‚æœå•†å“ç¼–ç æŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•å¤–éƒ¨æ¡ç æŸ¥è¯¢
                if (productData == null) {
                    try {
                        Log.d("InboundActivity", "å•†å“ç¼–ç æŸ¥è¯¢æ— ç»“æœï¼Œå°è¯•å¤–éƒ¨æ¡ç æŸ¥è¯¢: $productCode")
                        val response = ApiClient.getApiService().getProductByExternalCode(productCode)
                        Log.d("InboundActivity", "å¤–éƒ¨æ¡ç APIå“åº”çŠ¶æ€: ${response.code()}")
                        
                        if (response.isSuccessful) {
                            val apiResponse = response.body()
                            Log.d("InboundActivity", "å¤–éƒ¨æ¡ç APIå“åº”: success=${apiResponse?.success}, dataå­˜åœ¨=${apiResponse?.data != null}")
                            
                            if (apiResponse?.success == true && apiResponse.data != null) {
                                productData = apiResponse.data
                                productName = productData.product_name
                                skuCode = productData.matched_sku?.sku_code ?: productCode
                                
                                // ğŸ”’ å¦‚æœæœ¬åœ°è§£ææˆåŠŸï¼Œåˆ™ç»å¯¹ä½¿ç”¨æœ¬åœ°è§£æç»“æœï¼Œå®Œå…¨å¿½ç•¥å¤–éƒ¨APIæ•°æ®
                                if (useLocalParsing) {
                                    // å¼ºåˆ¶ä½¿ç”¨é”å®šçš„æœ¬åœ°è§£æç»“æœ
                                    defaultColor = lockedColor
                                    defaultSize = lockedSize
                                    Log.d("InboundActivity", "ğŸ”’ å¼ºåˆ¶ä½¿ç”¨æœ¬åœ°è§£æ: é¢œè‰²=$lockedColor, å°ºç =$lockedSize (å®Œå…¨å¿½ç•¥å¤–éƒ¨API)")
                                } else {
                                    // åªæœ‰æœ¬åœ°è§£æå¤±è´¥æ—¶ï¼Œæ‰ä½¿ç”¨å¤–éƒ¨APIçš„é¢œè‰²å°ºç ä¿¡æ¯
                                    if (productData.matched_sku?.sku_color?.isNotEmpty() == true) {
                                        defaultColor = productData.matched_sku.sku_color
                                        Log.d("InboundActivity", "âœ… ä½¿ç”¨å¤–éƒ¨APIé¢œè‰²: $defaultColor (æœ¬åœ°è§£æå¤±è´¥)")
                                    }
                                    if (productData.matched_sku?.sku_size?.isNotEmpty() == true) {
                                        defaultSize = productData.matched_sku.sku_size
                                        Log.d("InboundActivity", "âœ… ä½¿ç”¨å¤–éƒ¨APIå°ºç : $defaultSize (æœ¬åœ°è§£æå¤±è´¥)")
                                    }
                                }
                                Log.d("InboundActivity", "âœ… å¤–éƒ¨APIæœ€ç»ˆä½¿ç”¨ç»“æœ: é¢œè‰²=$defaultColor, å°ºç =$defaultSize")
                                
                                // è·å–å›¾ç‰‡URL - ä¼˜å…ˆä½¿ç”¨åŒ¹é…çš„SKUå›¾ç‰‡ï¼Œç„¶åæ˜¯å•†å“å›¾ç‰‡
                                val rawImageUrl = productData.matched_sku?.image_path 
                                    ?: productData.image_path 
                                    ?: ""
                                
                                // å¤„ç†å›¾ç‰‡URLï¼Œå¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„åˆ™æ‹¼æ¥æœåŠ¡å™¨åœ°å€
                                imageUrl = if (rawImageUrl.isNotEmpty()) {
                                    if (rawImageUrl.startsWith("http://") || rawImageUrl.startsWith("https://")) {
                                        rawImageUrl
                                    } else {
                                        val baseUrl = ApiClient.getServerUrl(this@InboundActivity)
                                        "${baseUrl.trimEnd('/')}/$rawImageUrl"
                                    }
                                } else {
                                    ""
                                }
                                
                                Log.d("InboundActivity", "å¤–éƒ¨æ¡ç æŸ¥è¯¢æˆåŠŸ: name=$productName, colors=${productData.colors?.size}, skus=${productData.skus?.size}")
                            } else {
                                Log.w("InboundActivity", "å¤–éƒ¨æ¡ç APIè¿”å›å¤±è´¥æˆ–æ— æ•°æ®: ${apiResponse?.error_message}")
                            }
                        } else {
                            Log.w("InboundActivity", "å¤–éƒ¨æ¡ç APIè°ƒç”¨å¤±è´¥: ${response.code()} - ${response.message()}")
                        }
                    } catch (e: Exception) {
                        Log.e("InboundActivity", "å¤–éƒ¨æ¡ç æŸ¥è¯¢å¼‚å¸¸: ${e.message}", e)
                    }
                }

                runOnUiThread {
                    // å¦‚æœè·å–åˆ°äº†å•†å“æ•°æ®ï¼Œè®¾ç½®çœŸå®çš„SKUé€‰é¡¹
                    if (productData != null) {
                        inboundListAdapter.setProductSkuOptions(
                            productCode = productCode,
                            colors = productData.colors,
                            skus = productData.skus
                        )
                    }
                    
                    val finalSkuCode = skuCode ?: productCode
                    
                    // ğŸ”’ æœ€ç»ˆç¡®ä¿ä½¿ç”¨é”å®šçš„æœ¬åœ°è§£æç»“æœ
                    if (useLocalParsing) {
                        defaultColor = lockedColor
                        defaultSize = lockedSize
                        Log.d("InboundActivity", "ğŸ”’ æœ€ç»ˆé”å®šç¡®è®¤: é¢œè‰²=$lockedColor, å°ºç =$lockedSize")
                    } else if (productData != null && productData.colors != null && productData.colors.isNotEmpty()) {
                        // ğŸ¯ å¯¹äºæœ‰å¤šç§é¢œè‰²çš„å•†å“ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªé¢œè‰²ä½œä¸ºåˆå§‹é€‰æ‹©ï¼ˆç”¨æˆ·å¯ä»¥ä¿®æ”¹ï¼‰
                        defaultColor = productData.colors[0].color
                        // è·å–è¯¥é¢œè‰²çš„ç¬¬ä¸€ä¸ªå°ºç 
                        if (productData.colors[0].sizes != null && productData.colors[0].sizes!!.isNotEmpty()) {
                            defaultSize = productData.colors[0].sizes!![0].sku_size ?: "å‡ç "
                        }
                        Log.d("InboundActivity", "ğŸ¨ è®¾ç½®åˆå§‹é¢œè‰²é€‰æ‹©: $defaultColor, å°ºç : $defaultSize (ç”¨æˆ·å¯ä¿®æ”¹)")
                    }
                    
                    // æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
                    Log.d("InboundActivity", "=== é‡å¤æ£€æŸ¥è°ƒè¯•ä¿¡æ¯ ===")
                    Log.d("InboundActivity", "æ‰«ææ¡ç : $productCode")
                    Log.d("InboundActivity", "æœ€ç»ˆSKU: $finalSkuCode")
                    Log.d("InboundActivity", "é€‰æ‹©è´§ä½: $selectedLocation")
                    Log.d("InboundActivity", "é»˜è®¤é¢œè‰²: $defaultColor")
                    Log.d("InboundActivity", "é»˜è®¤å°ºç : $defaultSize")
                    Log.d("InboundActivity", "æœ¬åœ°è§£æçŠ¶æ€: $useLocalParsing")
                    Log.d("InboundActivity", "å½“å‰åˆ—è¡¨ä¸­çš„å•†å“æ•°é‡: ${inboundItems.size}")
                    
                    // å…ˆä¿®å¤ç°æœ‰å•†å“çš„ç©ºè´§ä½é—®é¢˜ï¼ˆç»Ÿä¸€ä¸º"æ— è´§ä½"ï¼‰
                    for (i in inboundItems.indices) {
                        val item = inboundItems[i]
                        if (item.location.isEmpty()) {
                            inboundItems[i] = item.copy(location = "æ— è´§ä½")
                            Log.d("InboundActivity", "ä¿®å¤å•†å“[$i]è´§ä½: ç©ºç™½ -> æ— è´§ä½")
                        }
                    }
                    
                    // ä¿®å¤åé‡æ–°åˆ·æ–°é€‚é…å™¨
                    inboundListAdapter.notifyDataSetChanged()
                    
                    // æ‰“å°ç°æœ‰åˆ—è¡¨ä¸­çš„æ¯ä¸ªå•†å“ä¿¡æ¯
                    inboundItems.forEachIndexed { index, item ->
                        Log.d("InboundActivity", "å•†å“[$index]: sku=${item.sku}, location=${item.location}, color=${item.color}, size=${item.size}, quantity=${item.quantity}")
                    }
                    
                    // ä½¿ç”¨å®Œæ•´æ¡ç ä½œä¸ºæœ€ç»ˆSKUï¼Œç¡®ä¿ä¸€è‡´æ€§
                    val finalProductCode = productCode  // ä¿æŒå®Œæ•´æ¡ç ï¼š129092-é»„è‰²-XXL
                    
                    // ğŸ¯ ä¿®å¤é‡å¤æ£€æŸ¥ï¼šæ”¯æŒç®€å•æ¡ç å’Œå®Œæ•´æ¡ç çš„åŒ¹é…
                    val existingIndex = inboundItems.indexOfFirst { item ->
                        // ğŸ”§ æ™ºèƒ½SKUæ¯”è¾ƒï¼šæ”¯æŒç®€å•æ¡ç åŒ¹é…å®Œæ•´SKU
                        val skuMatch = if (productCode.contains("-")) {
                            // æ‰«æçš„æ˜¯å®Œæ•´æ¡ç ï¼Œç›´æ¥æ¯”è¾ƒ
                            item.sku == productCode
                        } else {
                            // æ‰«æçš„æ˜¯ç®€å•æ¡ç ï¼Œéœ€è¦åŒ¹é…ç›¸åŒå•†å“ç¼–ç ã€é¢œè‰²ã€å°ºç 
                            val itemParts = item.sku.split("-")
                            if (itemParts.size >= 3) {
                                val itemProductCode = itemParts[0]
                                itemProductCode == productCode && 
                                item.color == defaultColor && 
                                item.size == defaultSize
                            } else {
                                item.sku == productCode
                            }
                        }
                        
                        // æ ‡å‡†åŒ–è´§ä½æ¯”è¾ƒï¼šç©ºå­—ç¬¦ä¸²å’Œ"æ— è´§ä½"è§†ä¸ºç›¸åŒ
                        val normalizedItemLocation = if (item.location.isEmpty()) "æ— è´§ä½" else item.location
                        val normalizedSelectedLocation = if (selectedLocation.isEmpty()) "æ— è´§ä½" else selectedLocation
                        val locationMatch = normalizedItemLocation == normalizedSelectedLocation
                        
                        Log.d("InboundActivity", "ğŸ” æ¯”è¾ƒå•†å“: SKUåŒ¹é…=$skuMatch, è´§ä½åŒ¹é…=$locationMatch")
                        Log.d("InboundActivity", "å•†å“SKU: [${item.sku}] vs æ‰«æç : [$productCode]")
                        Log.d("InboundActivity", "å•†å“è´§ä½: [${item.location}] -> [$normalizedItemLocation] vs é€‰æ‹©è´§ä½: [$selectedLocation] -> [$normalizedSelectedLocation]")
                        Log.d("InboundActivity", "å•†å“é¢œè‰²: [${item.color}] vs é»˜è®¤é¢œè‰²: [$defaultColor]")
                        Log.d("InboundActivity", "å•†å“å°ºç : [${item.size}] vs é»˜è®¤å°ºç : [$defaultSize]")
                        
                        skuMatch && locationMatch
                    }
                    
                    Log.d("InboundActivity", "existingIndex = $existingIndex")
                    
                    if (existingIndex >= 0) {
                        // å¦‚æœå·²å­˜åœ¨ç›¸åŒå•†å“+è´§ä½ï¼Œå¢åŠ æ•°é‡
                        val existingItem = inboundItems[existingIndex]
                        Log.d("InboundActivity", "æ‰¾åˆ°é‡å¤å•†å“ï¼Œå‡†å¤‡ç´¯åŠ ï¼šåŸæ•°é‡=${existingItem.quantity}")
                        
                        val newQuantity = existingItem.quantity + 1
                        // åˆ›å»ºæ ‡å‡†åŒ–çš„SKUæ ¼å¼
                        val updatedSku = if (productCode.contains("-")) {
                            productCode  // å¦‚æœå·²ç»æ˜¯å®Œæ•´æ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨
                        } else {
                            "$productCode-$defaultColor-$defaultSize"  // åˆ›å»ºå®Œæ•´æ ¼å¼
                        }
                        
                        inboundItems[existingIndex] = existingItem.copy(
                            quantity = newQuantity,
                            sku = updatedSku, // ä½¿ç”¨æ ‡å‡†åŒ–çš„SKU
                            color = defaultColor, // æ›´æ–°é¢œè‰²
                            size = defaultSize   // æ›´æ–°å°ºç 
                        )
                        
                        // å¼ºåˆ¶åˆ·æ–°æ•´ä¸ªåˆ—è¡¨å’Œç•Œé¢
                        inboundListAdapter.notifyItemChanged(existingIndex)
                        inboundListAdapter.notifyDataSetChanged()  // å¼ºåˆ¶å…¨éƒ¨åˆ·æ–°
                        
                        Log.d("InboundActivity", "ç´¯åŠ å®Œæˆï¼šæ–°æ•°é‡=$newQuantity")
                        Log.d("InboundActivity", "ç•Œé¢åˆ·æ–°å®Œæˆ")
                        
                        // ğŸ“ ç´¯åŠ æˆåŠŸï¼Œæ›´æ–°é˜²é‡å¤è®°å½•ï¼ˆé˜²æ­¢çŸ­æ—¶é—´å†…é‡å¤ç´¯åŠ ï¼‰
                        lastScanTime = currentTime
                        lastScanCode = productCode
                        Log.d("InboundActivity", "ğŸ”’ æ›´æ–°é˜²é‡å¤è®°å½•ï¼ˆç´¯åŠ ï¼‰: $productCode")
                        
                        Toast.makeText(this@InboundActivity, "âœ… ç´¯åŠ æˆåŠŸï¼æ•°é‡: $newQuantity", Toast.LENGTH_LONG).show()
                        updateItemCount()
                        editProductCode.setText("")
                        editProductCode.requestFocus()
                        scanQueue.remove(productCode)
                        return@runOnUiThread
                    }
                    
                    // æ·»åŠ æ–°å•†å“åˆ°åˆ—è¡¨ - åˆ›å»ºæ ‡å‡†åŒ–çš„SKUæ ¼å¼
                    val standardizedSku = if (productCode.contains("-")) {
                        productCode  // å¦‚æœå·²ç»æ˜¯å®Œæ•´æ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨
                    } else {
                        "$productCode-$defaultColor-$defaultSize"  // åˆ›å»ºå®Œæ•´æ ¼å¼
                    }
                    
                    val newItem = InboundItem(
                        sku = standardizedSku,
                        product_name = productName,
                        location = selectedLocation,
                        quantity = 1,
                        color = defaultColor,
                        size = defaultSize,
                        image_url = imageUrl
                    )
                    inboundItems.add(newItem)
                    inboundListAdapter.notifyItemInserted(inboundItems.size - 1)
                    updateItemCount()
                    
                    // ğŸ“ æ–°å¢å•†å“æˆåŠŸï¼Œä¸æ›´æ–°é˜²é‡å¤è®°å½•ï¼ˆå…è®¸å†æ¬¡æ‰«ææ·»åŠ ç›¸åŒæ¡ç çš„ä¸åŒè§„æ ¼ï¼‰
                    Log.d("InboundActivity", "âœ… æ–°å¢å•†å“æˆåŠŸï¼Œä¸è®¾ç½®é˜²é‡å¤ï¼ˆå…è®¸ä¸åŒè§„æ ¼ï¼‰: $productCode")
                    
                    editProductCode.setText("")
                    editProductCode.requestFocus()
                    scanQueue.remove(productCode)
                    
                    val message = if (productData != null) {
                        if (productData.colors != null && productData.colors.size > 1) {
                            "âœ… å·²æ·»åŠ å•†å“ï¼Œå¯ç‚¹å‡»é€‰æ‹©é¢œè‰²/å°ºç  (å…±${productData.colors.size}ç§é¢œè‰²)"
                        } else {
                            "âœ… å·²æ·»åŠ å•†å“åˆ°å…¥åº“æ¸…å•"
                        }
                    } else {
                        "âœ… å·²æ·»åŠ å•†å“åˆ°å…¥åº“æ¸…å•ï¼ˆæœªæ‰¾åˆ°å•†å“ä¿¡æ¯ï¼‰"
                    }
                    Toast.makeText(this@InboundActivity, message, Toast.LENGTH_LONG).show()
                }
            } catch (e: Exception) {
                Log.e("InboundActivity", "æŸ¥è¯¢å•†å“å¤±è´¥: ${e.message}")
                runOnUiThread {
                    // ğŸ”’ APIå®Œå…¨å¤±è´¥æ—¶ï¼Œå¿…é¡»ä½¿ç”¨æœ¬åœ°è§£æç»“æœï¼Œä¸å…è®¸ä½¿ç”¨"é»˜è®¤é¢œè‰²"
                    val localParsedInfo = parseProductCodeLocally(productCode)
                    if (localParsedInfo == null) {
                        // å¦‚æœæœ¬åœ°è§£æä¹Ÿå¤±è´¥ï¼Œç›´æ¥æç¤ºé”™è¯¯ï¼Œä¸åˆ›å»ºå•†å“
                        Toast.makeText(this@InboundActivity, "æ¡ç æ ¼å¼é”™è¯¯ï¼š$productCodeï¼Œè¯·ç¡®è®¤æ¡ç æ ¼å¼ä¸º å•†å“ç¼–ç -é¢œè‰²-å°ºç ", Toast.LENGTH_LONG).show()
                        editProductCode.setText("")
                        editProductCode.requestFocus()
                        scanQueue.remove(productCode)
                        return@runOnUiThread
                    }
                    
                    // ğŸ”’ å¼ºåˆ¶ä½¿ç”¨æœ¬åœ°è§£æç»“æœï¼Œç»å¯¹ä¸å…è®¸"é»˜è®¤é¢œè‰²"
                    val finalColor = localParsedInfo.color
                    val finalSize = localParsedInfo.size
                    
                    Log.d("InboundActivity", "ğŸ› ï¸ APIå¤±è´¥ï¼Œä½¿ç”¨æœ€ç»ˆè§£æç»“æœ: é¢œè‰²=$finalColor, å°ºç =$finalSize")
                    
                    // ğŸ”’ ä½¿ç”¨å®Œæ•´çš„æ¡ç ä½œä¸ºSKUï¼Œä¿æŒä¸€è‡´æ€§
                    val finalSku = productCode  // ä½¿ç”¨å®Œæ•´æ¡ç ï¼š129092-é»„è‰²-XXL
                    
                    Log.d("InboundActivity", "ğŸ” æœ€ç»ˆSKU: $finalSku, é¢œè‰²: $finalColor, å°ºç : $finalSize, è´§ä½: $selectedLocation")
                    
                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒå•†å“
                    val existingIndex = inboundItems.indexOfFirst { item ->
                        item.sku == finalSku && 
                        item.location == selectedLocation &&
                        item.color == finalColor &&
                        item.size == finalSize
                    }
                    
                    if (existingIndex >= 0) {
                        // å¦‚æœå·²å­˜åœ¨ç›¸åŒå•†å“ï¼Œå¢åŠ æ•°é‡
                        val existingItem = inboundItems[existingIndex]
                        val newQuantity = existingItem.quantity + 1
                        inboundItems[existingIndex] = existingItem.copy(quantity = newQuantity)
                        inboundListAdapter.notifyItemChanged(existingIndex)
                        Log.d("InboundActivity", "âœ… ç´¯åŠ å•†å“æ•°é‡: SKU=$finalSku, åŸæ•°é‡=${existingItem.quantity}, æ–°æ•°é‡=$newQuantity")
                        
                        // ğŸ“ ç´¯åŠ æˆåŠŸï¼Œæ›´æ–°é˜²é‡å¤è®°å½•ï¼ˆé˜²æ­¢çŸ­æ—¶é—´å†…é‡å¤ç´¯åŠ ï¼‰
                        lastScanTime = currentTime
                        lastScanCode = productCode
                        Log.d("InboundActivity", "ğŸ”’ æ›´æ–°é˜²é‡å¤è®°å½•ï¼ˆç´¯åŠ ï¼‰: $productCode")
                        
                        Toast.makeText(this@InboundActivity, "å·²å¢åŠ å•†å“æ•°é‡: $newQuantity", Toast.LENGTH_SHORT).show()
                        updateItemCount()
                        editProductCode.setText("")
                        editProductCode.requestFocus()
                        scanQueue.remove(productCode)
                        return@runOnUiThread
                    }
                    
                    val newItem = InboundItem(
                        sku = finalSku,
                        product_name = localParsedInfo.productCode,
                        location = selectedLocation,
                        quantity = 1,
                        color = finalColor,
                        size = finalSize,
                        image_url = ""
                    )
                    inboundItems.add(newItem)
                    inboundListAdapter.notifyItemInserted(inboundItems.size - 1)
                    updateItemCount()
                    
                    // ğŸ“ æ–°å¢å•†å“æˆåŠŸï¼Œä¸æ›´æ–°é˜²é‡å¤è®°å½•ï¼ˆå…è®¸å†æ¬¡æ‰«ææ·»åŠ ç›¸åŒæ¡ç çš„ä¸åŒè§„æ ¼ï¼‰
                    Log.d("InboundActivity", "âœ… æ–°å¢å•†å“æˆåŠŸï¼Œä¸è®¾ç½®é˜²é‡å¤ï¼ˆå…è®¸ä¸åŒè§„æ ¼ï¼‰: $productCode")
                    
                    editProductCode.setText("")
                    editProductCode.requestFocus()
                    scanQueue.remove(productCode)
                    Toast.makeText(this@InboundActivity, "å·²æ·»åŠ å•†å“åˆ°å…¥åº“æ¸…å•ï¼ˆä½¿ç”¨æœ¬åœ°è§£æï¼š$finalColor-$finalSizeï¼‰", Toast.LENGTH_SHORT).show()
                }
            }
        }
    }

    private fun removeItemAt(position: Int) {
        if (position < inboundItems.size) {
            inboundItems.removeAt(position)
            inboundListAdapter.notifyItemRemoved(position)
            inboundListAdapter.notifyItemRangeChanged(position, inboundItems.size)
            updateItemCount()
        }
    }
    
    // ğŸ“¦ æœ¬åœ°æ¡ç è§£ææ•°æ®ç±»
    data class LocalProductInfo(
        val productCode: String,
        val color: String,
        val size: String
    )
    
    // ğŸ” æœ¬åœ°è§£æå•†å“æ¡ç ï¼ˆæ ¼å¼ï¼šå•†å“ç¼–ç -é¢œè‰²-å°ºç ï¼‰
    private fun parseProductCodeLocally(code: String): LocalProductInfo? {
        try {
            Log.d("InboundActivity", "ğŸ” å¼€å§‹æœ¬åœ°è§£ææ¡ç : $code")
            
            // æ”¯æŒçš„æ ¼å¼ï¼š129092-é»„è‰²-XXL, 129092-é»„è‰²-M, ABC123-çº¢è‰²-L ç­‰
            val parts = code.split("-")
            
            if (parts.size >= 3) {
                val productCode = parts[0]
                val color = parts[1]
                val size = parts[2]
                
                // éªŒè¯æ ¼å¼æ˜¯å¦åˆç†
                if (productCode.isNotEmpty() && color.isNotEmpty() && size.isNotEmpty()) {
                    Log.d("InboundActivity", "âœ… æœ¬åœ°è§£ææˆåŠŸ: å•†å“=$productCode, é¢œè‰²=$color, å°ºç =$size")
                    return LocalProductInfo(productCode, color, size)
                }
            }
            
            Log.d("InboundActivity", "âŒ æ¡ç æ ¼å¼ä¸ç¬¦åˆæœ¬åœ°è§£æè§„åˆ™: $code")
            return null
        } catch (e: Exception) {
            Log.e("InboundActivity", "âŒ æœ¬åœ°è§£æå¼‚å¸¸: ${e.message}", e)
            return null
        }
    }
    
    private fun mergeduplicateItems() {
        Log.d("InboundActivity", "ğŸ§¹ å¼€å§‹åˆå¹¶é‡å¤å•†å“...")
        Log.d("InboundActivity", "ğŸ§¹ åˆå¹¶å‰åˆ—è¡¨å¤§å°: ${inboundItems.size}")
        
        // æ‰“å°åˆå¹¶å‰çš„è¯¦ç»†ä¿¡æ¯
        inboundItems.forEachIndexed { index, item ->
            Log.d("InboundActivity", "ğŸ§¹ åˆå¹¶å‰[$index]: sku=${item.sku}, location=${item.location}, color=${item.color}, size=${item.size}, quantity=${item.quantity}")
        }
        
        val mergedMap = mutableMapOf<String, InboundItem>()
        
        for (item in inboundItems) {
            val key = "${item.sku}_${item.location}_${item.color}_${item.size}"
            Log.d("InboundActivity", "ğŸ§¹ å¤„ç†å•†å“: $key")
            
            if (mergedMap.containsKey(key)) {
                // å¦‚æœå·²å­˜åœ¨ç›¸åŒçš„å•†å“ï¼Œç´¯åŠ æ•°é‡
                val existing = mergedMap[key]!!
                val newQuantity = existing.quantity + item.quantity
                mergedMap[key] = existing.copy(quantity = newQuantity)
                Log.d("InboundActivity", "ğŸ§¹ åˆå¹¶å•†å“: ${item.sku} æ•°é‡: ${existing.quantity} + ${item.quantity} = $newQuantity")
            } else {
                // å¦‚æœæ˜¯æ–°å•†å“ï¼Œç›´æ¥æ·»åŠ 
                mergedMap[key] = item
                Log.d("InboundActivity", "ğŸ§¹ æ–°å¢å•†å“: $key")
            }
        }
        
        val originalSize = inboundItems.size
        val mergedList = mergedMap.values.toMutableList()
        
        Log.d("InboundActivity", "ğŸ§¹ åˆå¹¶ååˆ—è¡¨å¤§å°: ${mergedList.size}")
        
        if (mergedList.size != originalSize) {
            inboundItems.clear()
            inboundItems.addAll(mergedList)
            
            // ğŸ”§ å®‰å…¨åœ°æ›´æ–°é€‚é…å™¨ï¼Œé¿å…å´©æºƒ
            runOnUiThread {
                try {
                    inboundListAdapter.notifyDataSetChanged()
                    updateItemCount()
                    Log.d("InboundActivity", "ğŸ§¹ é€‚é…å™¨æ›´æ–°å®Œæˆ")
                } catch (e: Exception) {
                    Log.e("InboundActivity", "ğŸ§¹ é€‚é…å™¨æ›´æ–°å¤±è´¥: ${e.message}", e)
                }
            }
            
            Log.d("InboundActivity", "ğŸ§¹ åˆå¹¶å®Œæˆ: $originalSize æ¡è®°å½•åˆå¹¶ä¸º ${mergedList.size} æ¡")
            Toast.makeText(this, "å·²åˆå¹¶é‡å¤å•†å“ï¼š$originalSize æ¡ â†’ ${mergedList.size} æ¡", Toast.LENGTH_LONG).show()
        } else {
            Log.d("InboundActivity", "ğŸ§¹ æ— éœ€åˆå¹¶: æ²¡æœ‰é‡å¤è®°å½•")
        }
        
        // æ‰“å°åˆå¹¶åçš„è¯¦ç»†ä¿¡æ¯
        inboundItems.forEachIndexed { index, item ->
            Log.d("InboundActivity", "ğŸ§¹ åˆå¹¶å[$index]: sku=${item.sku}, location=${item.location}, color=${item.color}, size=${item.size}, quantity=${item.quantity}")
        }
    }

    private fun confirmInbound() {
        if (inboundItems.isEmpty()) {
            Toast.makeText(this, "å…¥åº“æ¸…å•ä¸ºç©º", Toast.LENGTH_SHORT).show()
            return
        }

        val totalItems = inboundItems.sumOf { it.quantity }
        
        AlertDialog.Builder(this)
            .setTitle("ç¡®è®¤å…¥åº“")
            .setMessage("ç¡®å®šè¦æäº¤ ${inboundItems.size} ç§å•†å“ï¼Œå…± $totalItems ä»¶çš„å…¥åº“æ“ä½œå—ï¼Ÿ")
            .setPositiveButton("ç¡®è®¤å…¥åº“") { _, _ ->
                performInbound()
            }
            .setNegativeButton("å–æ¶ˆ", null)
            .show()
    }

    private fun performInbound() {
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!ApiClient.isLoggedIn()) {
            Toast.makeText(this, "ç”¨æˆ·æœªç™»å½•ï¼Œè¯·é‡æ–°ç™»å½•", Toast.LENGTH_SHORT).show()
            val intent = Intent(this, LoginActivity::class.java)
            startActivity(intent)
            finish()
            return
        }
        
        // è·å–ç”¨æˆ·IDï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨é»˜è®¤å€¼
        var userId = ApiClient.getCurrentUserId()
        if (userId.isNullOrEmpty()) {
            userId = "wms_user"  // ä½¿ç”¨é»˜è®¤ç”¨æˆ·ID
            Log.d("InboundActivity", "ä½¿ç”¨é»˜è®¤ç”¨æˆ·ID: $userId")
        }

        btnConfirmInbound.isEnabled = false
        btnConfirmInbound.text = "å…¥åº“ä¸­..."

        lifecycleScope.launch {
            var successCount = 0
            var failCount = 0
            val errorMessages = mutableListOf<String>()

            for (item in inboundItems) {
                try {
                    // ğŸ”§ æ›´æ–°ä¸ºæ–°çš„APIç»“æ„ï¼Œä½¿ç”¨snake_caseå­—æ®µå
                    val request = InboundRequest(
                        sku_code = item.sku,  // ä½¿ç”¨å®Œæ•´çš„SKUç¼–ç 
                        location_code = if (item.location == "æ— è´§ä½") null else item.location,  // æ— è´§ä½æ—¶ä¼ null
                        stock_quantity = item.quantity,
                        operator_id = userId,  // æ“ä½œå‘˜ID
                        batch_number = if (item.batch.isNotEmpty()) item.batch else null,
                        is_urgent = false,
                        notes = "PDAå…¥åº“ - ${item.color} ${item.size}"
                    )

                    Log.d("InboundActivity", "å‘é€å…¥åº“è¯·æ±‚: sku_code=${item.sku}, location_code=${item.location}, quantity=${item.quantity}")
                    
                    val response = ApiClient.getApiService().inbound(request)
                    if (response.isSuccessful) {
                        val apiResponse = response.body()
                        if (apiResponse?.success == true) {
                            successCount++
                            Log.d("InboundActivity", "âœ… å…¥åº“æˆåŠŸ: ${item.sku}")
                        } else {
                            failCount++
                            val errorMsg = "${item.sku}: ${apiResponse?.error_message ?: "å…¥åº“å¤±è´¥"}"
                            errorMessages.add(errorMsg)
                            Log.e("InboundActivity", "âŒ å…¥åº“å¤±è´¥: $errorMsg")
                        }
                    } else {
                        failCount++
                        val errorMsg = "${item.sku}: HTTP ${response.code()} - ${response.message()}"
                        errorMessages.add(errorMsg)
                        Log.e("InboundActivity", "âŒ å…¥åº“HTTPé”™è¯¯: $errorMsg")
                    }
                } catch (e: Exception) {
                    failCount++
                    val errorMsg = "${item.sku}: ${e.message}"
                    errorMessages.add(errorMsg)
                    Log.e("InboundActivity", "âŒ å…¥åº“å¼‚å¸¸: $errorMsg", e)
                }
            }

            runOnUiThread {
                btnConfirmInbound.isEnabled = true
                btnConfirmInbound.text = "ç¡®è®¤å…¥åº“"

                val message = if (failCount == 0) {
                    "å…¥åº“å®Œæˆï¼\næˆåŠŸå…¥åº“ $successCount ç§å•†å“"
                } else {
                    "éƒ¨åˆ†å…¥åº“å®Œæˆ\næˆåŠŸ: $successCount ç§\nå¤±è´¥: $failCount ç§\n\né”™è¯¯è¯¦æƒ…:\n${errorMessages.joinToString("\n")}"
                }

                AlertDialog.Builder(this@InboundActivity)
                    .setTitle("å…¥åº“ç»“æœ")
                    .setMessage(message)
                    .setPositiveButton("ç¡®å®š") { _, _ ->
                        if (successCount > 0) {
                            // æ¸…ç©ºæ¸…å•
                            inboundItems.clear()
                            inboundListAdapter.notifyDataSetChanged()
                            updateItemCount()
                            editProductCode.setText("")
                            editProductCode.requestFocus()
                        }
                    }
                    .setCancelable(false)
                    .show()
            }
        }
    }

    private fun updateItemCount() {
        val itemCount = inboundItems.size
        val totalQuantity = inboundItems.sumOf { it.quantity }
        
        txtInboundTitle.text = "å…¥åº“å•†å“($itemCount)"
        btnConfirmInbound.text = "ç¡®è®¤å…¥åº“"
        btnConfirmInbound.isEnabled = itemCount > 0
        
        if (itemCount > 0) {
            btnConfirmInbound.setBackgroundColor(ContextCompat.getColor(this, android.R.color.holo_blue_bright))
        } else {
            btnConfirmInbound.setBackgroundColor(ContextCompat.getColor(this, android.R.color.darker_gray))
        }
    }

    override fun onDestroy() {
        super.onDestroy()
        try {
            unregisterReceiver(scanReceiver)
        } catch (e: Exception) {
            // å¿½ç•¥å¼‚å¸¸
        }
    }
} 